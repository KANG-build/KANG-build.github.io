---
layout: default
title: SRC Lab. Member Blog
---
<div class="blog-page member-blog-page">
    <div class="container">
        <!-- Member Header (populated by JS) -->
        <div class="member-blog-header" id="memberBlogHeader">
            <div class="member-blog-profile">
                <img id="memberPhoto" src="" alt="member" class="member-blog-photo img-circle">
                <div class="member-blog-info">
                    <h1 id="memberName" class="member-blog-name"></h1>
                    <p id="memberRole" class="member-blog-role"></p>
                    <p id="memberEmail" class="member-blog-email"></p>
                    <div class="member-blog-stats">
                        <span class="stat-item"><span class="glyphicon glyphicon-list-alt"></span> 게시글 <strong id="postCount">0</strong></span>
                        <span class="stat-item"><span class="glyphicon glyphicon-heart"></span> 받은 반응 <strong id="totalReactions">0</strong></span>
                    </div>
                </div>
            </div>
            <a href="/pages/blog.html" class="btn-back-to-blog">
                <span class="glyphicon glyphicon-arrow-left"></span> 전체 블로그로 돌아가기
            </a>
        </div>

        <!-- Member's Posts -->
        <div class="blog-table-wrapper">
            <table class="blog-table">
                <thead>
                    <tr>
                        <th class="col-num">#</th>
                        <th class="col-category">카테고리</th>
                        <th class="col-title">제목</th>
                        <th class="col-date">날짜</th>
                        <th class="col-reactions">반응</th>
                    </tr>
                </thead>
                <tbody id="memberBlogTableBody">
                    {% assign sorted_posts = site.data.blog.posts | sort: "date" | reverse %}
                    {% for post in sorted_posts %}
                    <tr class="blog-row member-post-row" 
                        data-category="{{ post.category }}" 
                        data-author="{{ post.author_id }}"
                        data-id="{{ post.id }}"
                        onclick="openPost('{{ post.id }}')"
                        style="display:none;">
                        <td class="col-num"></td>
                        <td class="col-category">
                            <span class="blog-category-badge cat-{{ post.category | slugify }}">{{ post.category }}</span>
                        </td>
                        <td class="col-title">
                            <div class="blog-title-row">
                                <span class="blog-post-title">{{ post.title }}</span>
                            </div>
                            <div class="blog-post-tags">
                                {% for tag in post.tags %}
                                <span class="blog-tag">#{{ tag }}</span>
                                {% endfor %}
                            </div>
                        </td>
                        <td class="col-date">{{ post.date }}</td>
                        <td class="col-reactions">
                            <span class="reaction-summary" id="reaction-summary-{{ post.id }}">
                                <span class="reaction-mini">&#10084;&#65039; <span class="cnt" data-type="heart">0</span></span>
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Empty state -->
        <div class="blog-empty-state" id="emptyState" style="display:none;">
            <span class="glyphicon glyphicon-pencil" style="font-size:48px; color:#ccc;"></span>
            <h3>아직 작성된 글이 없습니다</h3>
            <p>이 멤버의 첫 번째 블로그 글을 기대해주세요!</p>
        </div>
    </div>
</div>

<!-- Post Detail Modal -->
<div class="blog-modal-overlay" id="postModal">
    <div class="blog-modal">
        <div class="blog-modal-header">
            <button class="blog-modal-close" onclick="closePost()">
                <span class="glyphicon glyphicon-remove"></span>
            </button>
        </div>
        <div class="blog-modal-body" id="postModalBody">
        </div>
    </div>
</div>

<!-- Hidden post data for JS -->
<div id="postData" style="display:none;">
{% for post in site.data.blog.posts %}
<div class="post-content-data" 
     data-id="{{ post.id }}" 
     data-title="{{ post.title }}"
     data-author="{{ post.author }}"
     data-author-id="{{ post.author_id }}"
     data-date="{{ post.date }}"
     data-category="{{ post.category }}"
     data-tags="{{ post.tags | join: ',' }}"
     data-summary="{{ post.summary }}">
{{ post.content | markdownify }}
</div>
{% endfor %}
</div>

<!-- Hidden member data for JS -->
<div id="memberData" style="display:none;">
{% for person in site.data.people.member %}
<div class="member-info-data"
     data-name="{{ person.name }}"
     data-photo="{{ person.photo }}"
     data-role="{{ person.role }}"
     data-email="{{ person.email }}"
     data-link="{{ person.link }}"
     data-id="{{ person.name | remove: ' ' | downcase }}">
</div>
{% endfor %}
</div>

<script>
var API_BASE = window.location.origin;
var __currentUser = null;

// ==================== Auth Check ====================
(function() {
    fetch(API_BASE + '/api/auth/me', { credentials: 'same-origin' })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.logged_in) {
            __currentUser = data.user;
        }
    }).catch(function() {});
})();

function escapeAttr(str) {
    if (!str) return '';
    return str.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Build member photo map
var memberPhotoMap = {};
(function() {
    document.querySelectorAll('.member-info-data').forEach(function(el) {
        memberPhotoMap[el.getAttribute('data-id')] = el.getAttribute('data-photo') || '/image/people/empty.png';
    });
})();

// ==================== Thumbnail Extraction ====================
function extractThumbnail(postId) {
    var el = document.querySelector('.post-content-data[data-id="'+postId+'"]');
    if (!el) return null;
    var img = el.querySelector('img');
    if (img) return img.getAttribute('src');
    var html = el.innerHTML;
    var m = html.match(/<img[^>]+src=["']([^"']+)["']/i);
    return m ? m[1] : null;
}

// Inject thumbnails into table rows
(function() {
    document.querySelectorAll('.blog-row').forEach(function(row) {
        var postId = row.getAttribute('data-id');
        var thumb = extractThumbnail(postId);
        if (thumb) {
            var titleCell = row.querySelector('.blog-title-row');
            if (titleCell) {
                var imgEl = document.createElement('img');
                imgEl.src = thumb;
                imgEl.className = 'blog-thumb';
                imgEl.alt = '';
                titleCell.insertBefore(imgEl, titleCell.firstChild);
            }
        }
    });
})();

// ==================== Reaction System ====================
function getReactions(postId) {
    var data = localStorage.getItem('srclab_reactions_' + postId);
    if (data) return JSON.parse(data);
    return { heart: 0, like: 0, dislike: 0 };
}

function getUserReaction(postId) {
    return localStorage.getItem('srclab_user_reaction_' + postId) || null;
}

function setReaction(postId, type) {
    var current = getUserReaction(postId);
    var reactions = getReactions(postId);

    if (current === type) {
        reactions[type] = Math.max(0, reactions[type] - 1);
        localStorage.removeItem('srclab_user_reaction_' + postId);
    } else {
        if (current) {
            reactions[current] = Math.max(0, reactions[current] - 1);
        }
        reactions[type] = (reactions[type] || 0) + 1;
        localStorage.setItem('srclab_user_reaction_' + postId, type);
    }

    localStorage.setItem('srclab_reactions_' + postId, JSON.stringify(reactions));
    updateReactionUI(postId);
    updateTableReactions(postId);
    updateTotalReactions();
}

function updateReactionUI(postId) {
    var reactions = getReactions(postId);
    var userReaction = getUserReaction(postId);

    var container = document.getElementById('modal-reactions-' + postId);
    if (!container) return;

    var btns = container.querySelectorAll('.reaction-btn');
    btns.forEach(function(btn) {
        var type = btn.getAttribute('data-type');
        var cntEl = btn.querySelector('.reaction-count');
        if (cntEl) cntEl.textContent = reactions[type] || 0;
        btn.classList.toggle('active', userReaction === type);
    });
}

function updateTableReactions(postId) {
    var reactions = getReactions(postId);
    var el = document.getElementById('reaction-summary-' + postId);
    if (el) {
        var heartCnt = el.querySelector('.cnt[data-type="heart"]');
        if (heartCnt) {
            var total = (reactions.heart || 0) + (reactions.like || 0);
            heartCnt.textContent = total;
        }
    }
}

function updateTotalReactions() {
    var rows = document.querySelectorAll('.member-post-row:not([style*="display: none"])');
    var total = 0;
    rows.forEach(function(row) {
        var postId = row.getAttribute('data-id');
        var reactions = getReactions(postId);
        total += (reactions.heart || 0) + (reactions.like || 0);
    });
    document.getElementById('totalReactions').textContent = total;
}

// ==================== Comments with Replies ====================
function loadComments(postId) {
    var container = document.getElementById('comments-section-' + postId);
    if (!container) return;
    var list = container.querySelector('.comment-list');
    var countEl = container.querySelector('.comment-count');
    list.innerHTML = '<div style="text-align:center; padding:10px; color:#aaa;">댓글 불러오는 중...</div>';

    fetch(API_BASE + '/api/posts/' + postId + '/comments')
    .then(function(r) { return r.json(); })
    .then(function(comments) {
        var roots = [];
        var repliesMap = {};
        comments.forEach(function(c) {
            if (c.parent_id) {
                if (!repliesMap[c.parent_id]) repliesMap[c.parent_id] = [];
                repliesMap[c.parent_id].push(c);
            } else {
                roots.push(c);
            }
        });
        countEl.textContent = comments.length;
        if (comments.length === 0) {
            list.innerHTML = '<div class="comment-empty">아직 댓글이 없습니다. 첫 번째 댓글을 남겨보세요!</div>';
            return;
        }
        var h = '';
        roots.forEach(function(c) {
            h += renderComment(c, postId);
            var replies = repliesMap[c.id] || [];
            if (replies.length > 0) {
                h += '<div class="comment-replies">';
                replies.forEach(function(r) {
                    h += renderComment(r, postId, true);
                });
                h += '</div>';
            }
        });
        list.innerHTML = h;
    })
    .catch(function() {
        list.innerHTML = '<div class="comment-empty">댓글을 불러올 수 없습니다.</div>';
    });
}

function renderComment(c, postId, isReply) {
    var photo = memberPhotoMap[c.author_id] || '/image/people/empty.png';
    var dateStr = c.created_at ? c.created_at.substring(0, 16).replace('T', ' ') : '';
    var cls = isReply ? 'comment-item comment-reply-item' : 'comment-item';
    var replyIcon = isReply ? '<span class="reply-arrow">&#8627;</span> ' : '';
    var badge = '';
    if (c.is_member) {
        badge = '<span class="comment-badge comment-badge-member">멤버</span>';
    } else if (c.is_logged_in) {
        badge = '<span class="comment-badge comment-badge-user">회원</span>';
    }
    var h = '<div class="' + cls + '" data-comment-id="' + c.id + '">' +
         '<div class="comment-header">' +
         replyIcon +
         '<img src="' + photo + '" class="comment-avatar img-circle" alt="">' +
         '<div class="comment-meta">' +
         '<span class="comment-author">' + escapeHtml(c.author) + '</span>' + badge +
         '<span class="comment-date">' + dateStr + '</span>' +
         '</div>' +
         '<div class="comment-actions-right">';
    if (!isReply) {
        h += '<button class="comment-reply-btn" onclick="toggleReplyForm(\'' + c.id + '\',\'' + postId + '\')" title="답글">' +
             '<span class="glyphicon glyphicon-share-alt"></span> 답글</button>';
    }
    var canDelete = false;
    if (__currentUser) {
        if (__currentUser.role === 'member') canDelete = true;
        else if (__currentUser.id === c.author_id || __currentUser.member_id === c.author_id) canDelete = true;
    }
    if (canDelete) {
        h += '<button class="comment-delete-btn" onclick="deleteComment(\'' + c.id + '\',\'' + postId + '\')" title="삭제">' +
             '<span class="glyphicon glyphicon-trash"></span></button>';
    }
    h += '</div></div>' +
         '<div class="comment-body">' + escapeHtml(c.content) + '</div>';
    if (!isReply) {
        var replyNameVal = __currentUser ? escapeAttr(__currentUser.name) : escapeAttr(localStorage.getItem('srclab_comment_name') || '');
        h += '<div class="comment-reply-form-wrap" id="reply-form-' + c.id + '" style="display:none;">' +
             '<div class="comment-reply-form">';
        if (!__currentUser) {
            h += '<input type="text" class="comment-name-input reply-name-input" id="reply-name-' + c.id + '" placeholder="이름" maxlength="30" value="' + replyNameVal + '">';
        } else {
            h += '<input type="hidden" id="reply-name-' + c.id + '" value="' + replyNameVal + '">';
            h += '<div class="comment-logged-user"><img src="' + (__currentUser.photo || '/image/people/empty.png') + '" class="comment-avatar-sm img-circle" alt=""> ' + escapeHtml(__currentUser.name) + '</div>';
        }
        h += '<textarea class="comment-textarea reply-textarea" id="reply-content-' + c.id + '" placeholder="답글을 입력하세요..." rows="2" maxlength="500"></textarea>' +
             '<div class="comment-reply-form-actions">' +
             '<button class="comment-cancel-btn" onclick="toggleReplyForm(\'' + c.id + '\',\'' + postId + '\')">취소</button>' +
             '<button class="comment-submit-btn reply-submit-btn" onclick="submitReply(\'' + c.id + '\',\'' + postId + '\')">답글 등록</button>' +
             '</div></div></div>';
    }
    h += '</div>';
    return h;
}

function toggleReplyForm(commentId, postId) {
    var form = document.getElementById('reply-form-' + commentId);
    if (!form) return;
    var isShown = form.style.display !== 'none';
    form.style.display = isShown ? 'none' : 'block';
    if (!isShown) {
        var ta = document.getElementById('reply-content-' + commentId);
        if (ta) ta.focus();
    }
}

function submitReply(parentId, postId) {
    var nameInput = document.getElementById('reply-name-' + parentId);
    var contentInput = document.getElementById('reply-content-' + parentId);
    var author = nameInput.value.trim();
    var content = contentInput.value.trim();
    if (!author) { alert('이름을 입력해주세요.'); nameInput.focus(); return; }
    if (!content) { alert('답글 내용을 입력해주세요.'); contentInput.focus(); return; }

    var body = { content: content, parent_id: parentId };
    if (!__currentUser) {
        body.author = author;
        body.author_id = author.replace(/\s+/g,'').toLowerCase();
    }

    fetch(API_BASE + '/api/posts/' + postId + '/comments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(body)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            if (!__currentUser) localStorage.setItem('srclab_comment_name', author);
            loadComments(postId);
        } else {
            alert('답글 등록 실패: ' + (data.error || ''));
        }
    })
    .catch(function(e) { alert('오류: ' + e.message); });
}

function submitComment(postId) {
    var nameInput = document.getElementById('comment-name-' + postId);
    var contentInput = document.getElementById('comment-content-' + postId);
    var author = nameInput ? nameInput.value.trim() : (__currentUser ? __currentUser.name : '');
    var content = contentInput.value.trim();
    if (!author) { alert('이름을 입력해주세요.'); if(nameInput) nameInput.focus(); return; }
    if (!content) { alert('댓글 내용을 입력해주세요.'); contentInput.focus(); return; }

    var btn = document.getElementById('comment-submit-' + postId);
    btn.disabled = true; btn.textContent = '등록 중...';

    var body = { content: content };
    if (!__currentUser) {
        body.author = author;
        body.author_id = author.replace(/\s+/g,'').toLowerCase();
    }

    fetch(API_BASE + '/api/posts/' + postId + '/comments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(body)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        btn.disabled = false; btn.textContent = '등록';
        if (data.success) {
            contentInput.value = '';
            if (!__currentUser) localStorage.setItem('srclab_comment_name', author);
            loadComments(postId);
        } else {
            alert('댓글 등록 실패: ' + (data.error || ''));
        }
    })
    .catch(function(e) {
        btn.disabled = false; btn.textContent = '등록';
        alert('오류: ' + e.message);
    });
}

function deleteComment(commentId, postId) {
    if (!confirm('이 댓글을 삭제하시겠습니까?')) return;
    fetch(API_BASE + '/api/comments/' + commentId, { method: 'DELETE', credentials: 'same-origin' })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) loadComments(postId);
        else alert('삭제 실패: ' + (data.error || ''));
    });
}

function escapeHtml(text) {
    var map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
    return text.replace(/[&<>"']/g, function(m){return map[m];}).replace(/\n/g, '<br>');
}

// ==================== Post Detail Modal ====================
function openPost(postId) {
    var postEl = document.querySelector('.post-content-data[data-id="' + postId + '"]');
    if (!postEl) return;

    var title = postEl.getAttribute('data-title');
    var author = postEl.getAttribute('data-author');
    var authorId = postEl.getAttribute('data-author-id');
    var date = postEl.getAttribute('data-date');
    var category = postEl.getAttribute('data-category');
    var tags = postEl.getAttribute('data-tags').split(',');
    var summary = postEl.getAttribute('data-summary');
    var content = postEl.innerHTML;
    var reactions = getReactions(postId);
    var userReaction = getUserReaction(postId);
    var savedName = localStorage.getItem('srclab_comment_name') || '';

    var tagsHtml = tags.map(function(t) {
        return '<span class="blog-detail-tag">#' + t.trim() + '</span>';
    }).join(' ');

    // Comment form: different for logged-in vs anonymous
    var commentFormHtml = '';
    if (__currentUser) {
        commentFormHtml =
            '<div class="comment-form">' +
            '<div class="comment-logged-user" style="margin-bottom:10px;"><img src="' + (__currentUser.photo||'/image/people/empty.png') + '" class="comment-avatar-sm img-circle" alt=""> ' + escapeHtml(__currentUser.name) +
            (__currentUser.role==='member'?' <span class="comment-badge comment-badge-member">멤버</span>':'') + '</div>' +
            '<div class="comment-form-row">' +
                '<textarea class="comment-textarea" id="comment-content-' + postId + '" placeholder="댓글을 입력하세요..." rows="3" maxlength="1000"></textarea>' +
            '</div>' +
            '<div class="comment-form-actions">' +
                '<button class="comment-submit-btn" id="comment-submit-' + postId + '" onclick="submitComment(\'' + postId + '\')">등록</button>' +
            '</div>' +
            '</div>';
    } else {
        commentFormHtml =
            '<div class="comment-form">' +
            '<div class="comment-form-row">' +
                '<input type="text" class="comment-name-input" id="comment-name-' + postId + '" placeholder="이름" value="' + escapeAttr(savedName) + '" maxlength="30">' +
            '</div>' +
            '<div class="comment-form-row">' +
                '<textarea class="comment-textarea" id="comment-content-' + postId + '" placeholder="댓글을 입력하세요..." rows="3" maxlength="1000"></textarea>' +
            '</div>' +
            '<div class="comment-form-actions">' +
                '<button class="comment-submit-btn" id="comment-submit-' + postId + '" onclick="submitComment(\'' + postId + '\')">등록</button>' +
            '</div>' +
            '</div>';
    }

    var html = '' +
        '<div class="blog-detail">' +
        '  <span class="blog-category-badge cat-' + category.toLowerCase().replace(/\s+/g, '-') + '">' + category + '</span>' +
        '  <h1 class="blog-detail-title">' + title + '</h1>' +
        '  <div class="blog-detail-meta">' +
        '    <span class="blog-detail-author">' +
        '      <span class="glyphicon glyphicon-user"></span> ' + author +
        '    </span>' +
        '    <span class="blog-detail-date">' +
        '      <span class="glyphicon glyphicon-time"></span> ' + date +
        '    </span>' +
        '  </div>' +
        '  <div class="blog-detail-tags">' + tagsHtml + '</div>' +
        '  <div class="blog-detail-summary">' +
        '    <span class="glyphicon glyphicon-info-sign"></span> ' + summary +
        '  </div>' +
        '  <hr>' +
        '  <div class="blog-detail-content">' + content + '</div>' +
        '  <hr>' +
        '  <div class="blog-reactions" id="modal-reactions-' + postId + '">' +
        '    <span class="reactions-label">이 글이 도움이 되었나요?</span>' +
        '    <div class="reaction-buttons">' +
        '      <button class="reaction-btn' + (userReaction === 'heart' ? ' active' : '') + '" data-type="heart" onclick="setReaction(\'' + postId + '\', \'heart\')">' +
        '        <span class="reaction-emoji">&#10084;&#65039;</span>' +
        '        <span class="reaction-text">좋아요</span>' +
        '        <span class="reaction-count">' + (reactions.heart || 0) + '</span>' +
        '      </button>' +
        '      <button class="reaction-btn' + (userReaction === 'like' ? ' active' : '') + '" data-type="like" onclick="setReaction(\'' + postId + '\', \'like\')">' +
        '        <span class="reaction-emoji">&#128077;</span>' +
        '        <span class="reaction-text">추천</span>' +
        '        <span class="reaction-count">' + (reactions.like || 0) + '</span>' +
        '      </button>' +
        '      <button class="reaction-btn' + (userReaction === 'dislike' ? ' active' : '') + '" data-type="dislike" onclick="setReaction(\'' + postId + '\', \'dislike\')">' +
        '        <span class="reaction-emoji">&#128078;</span>' +
        '        <span class="reaction-text">비추천</span>' +
        '        <span class="reaction-count">' + (reactions.dislike || 0) + '</span>' +
        '      </button>' +
        '    </div>' +
        '  </div>' +
        // ===== COMMENTS SECTION =====
        '  <div class="comments-section" id="comments-section-' + postId + '">' +
        '    <h3 class="comments-title"><span class="glyphicon glyphicon-comment"></span> 댓글 <span class="comment-count">0</span></h3>' +
        '    <div class="comment-list"></div>' +
        commentFormHtml +
        '  </div>' +
        '</div>';

    document.getElementById('postModalBody').innerHTML = html;
    document.getElementById('postModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    loadComments(postId);
}

function closePost() {
    document.getElementById('postModal').classList.remove('active');
    document.body.style.overflow = '';
}

document.getElementById('postModal').addEventListener('click', function(e) {
    if (e.target === this) closePost();
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closePost();
});

// ==================== Member Page Init ====================
function getMemberIdFromURL() {
    var params = new URLSearchParams(window.location.search);
    return params.get('member') || '';
}

function initMemberPage() {
    var memberId = getMemberIdFromURL();
    if (!memberId) {
        window.location.href = '/pages/blog.html';
        return;
    }

    var memberEls = document.querySelectorAll('.member-info-data');
    var memberFound = false;
    memberEls.forEach(function(el) {
        var id = el.getAttribute('data-id');
        if (id === memberId) {
            memberFound = true;
            var photo = el.getAttribute('data-photo');
            var name = el.getAttribute('data-name');
            var role = el.getAttribute('data-role');
            var email = el.getAttribute('data-email');

            document.getElementById('memberPhoto').src = photo || '/image/people/empty.png';
            document.getElementById('memberName').textContent = name;
            document.getElementById('memberRole').textContent = role || '';
            document.getElementById('memberEmail').textContent = email || '';
        }
    });

    if (!memberFound) {
        var firstPost = document.querySelector('.member-post-row[data-author="' + memberId + '"]');
        if (firstPost) {
            document.getElementById('memberPhoto').src = '/image/people/empty.png';
        }
    }

    var rows = document.querySelectorAll('.member-post-row');
    var count = 0;
    rows.forEach(function(row) {
        if (row.getAttribute('data-author') === memberId) {
            row.style.display = '';
            count++;
        }
    });

    var visibleRows = document.querySelectorAll('.member-post-row:not([style*="display: none"])');
    var num = visibleRows.length;
    visibleRows.forEach(function(row) {
        row.querySelector('.col-num').textContent = num;
        num--;
    });

    document.getElementById('postCount').textContent = count;

    if (count === 0) {
        document.getElementById('emptyState').style.display = 'block';
    }

    visibleRows.forEach(function(row) {
        var postId = row.getAttribute('data-id');
        updateTableReactions(postId);
    });

    updateTotalReactions();
}

initMemberPage();
</script>
